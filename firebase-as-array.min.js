/*! Firebase.getAsArray - v0.1.0 - 2016-04-13
* Copyright (c) 2016 Kato
* MIT LICENSE */
!function(a){function b(a,b){this.list=[],this.snaps={},this.subs=[],this.ref=a,this.eventCallback=b,this._wrapList(),this._initPriorities(),this._initListeners()}function c(a,b){if(d(a)&&d(b)){var c;for(c in a)"$id"!==c&&a.hasOwnProperty(c)&&!b.hasOwnProperty(c)&&delete a[c];for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}return b}function d(a){return"object"==typeof a&&null!==a}function e(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c].$id===b)return c;return-1}function f(a){return a&&"object"==typeof a&&(delete a.$id,a.hasOwnProperty(".value")&&(a=a[".value"])),void 0===a&&(a=null),a}function g(a,b){return"object"==typeof b&&b||(b={".value":b}),b.$id=a,b}a.getAsArray=function(a,c){return new b(a,c).getList()};var h=5e-8;b.prototype={getList:function(){return this.list},add:function(a){var b=this,c=this.ref.push();if(0!==this.list.length){var d=this.snaps[this.list[this.list.length-1].$id].getPriority();c.setWithPriority(f(a),d+1,b._handleErrors.bind(b,c.key()))}else c.setWithPriority(f(a),0,this._handleErrors.bind(this,c.key()));return c},set:function(a,b){if(this.snaps.hasOwnProperty(a)){var c=this.snaps[a].getPriority();this.ref.child(a).setWithPriority(f(b),c,this._handleErrors.bind(this,a))}else{var d=this,e=this.ref.child(a);if(0!==this.list.length){var c=this.snaps[this.list[this.list.length-1].$id].getPriority();e.setWithPriority(f(b),c+1,d._handleErrors.bind(d,e.key()))}else e.setWithPriority(f(b),0,this._handleErrors.bind(this,e.key()))}},setAt:function(a,b){a>=0&&a<this.list.length&&this.set(this.list[a].$id,b)},update:function(a,b){this.snaps.hasOwnProperty(a)?this.ref.child(a).update(f(b),this._handleErrors.bind(this,a)):this.set(a,b)},updateAt:function(a,b){a>=0&&a<this.list.length&&this.update(this.list[a].$id,b)},setPriority:function(a,b){this.ref.child(a).setPriority(b)},remove:function(a){this.ref.child(a).remove(this._handleErrors.bind(null,a))},removeAt:function(a){a>=0&&a<this.list.length&&this.remove(this.list[a].$id)},insert:function(a,b){if(0===this.list.length||a>=this.list.length)return this.add(b);var c=this.ref.push();if(0===a){var d=this.snaps[this.list[0].$id].getPriority();c.setWithPriority(b,d-1)}else{var e=this.snaps[this.list[a-1].$id].getPriority(),f=this.snaps[this.list[a].$id].getPriority();if(h>f-e){for(var i={},j=0;j<this.list.length;j++)i[this.list[j].$id+"/.priority"]=j>=a?j+1:j;b=g(c.key(),b),delete b.$id,b[".priority"]=a,i[c.key()]=b,this.ref.update(i)}else{var d=(e+f)/2;c.setWithPriority(b,d)}}return c},move:function(a,b){if(a>=0&&a<this.list.length&&b>=0&&b!==a&&b!==a+1)if(b>this.list.length-1)this.snaps[this.list[a].$id].ref().setPriority(this.snaps[this.list[this.list.length-1].$id].getPriority()+1);else{var c=this.snaps[this.list[b-1].$id].getPriority(),d=this.snaps[this.list[b].$id].getPriority();if(h>d-c){var e;b>a?e=b-1:finalindex=b;for(var f={},g=0,i=0;i<this.list.length;i++)i===a?f[this.list[i].$id+"/.priority"]=e:b>i?(f[this.list[i].$id+"/.priority"]=g,g++):(f[this.list[i].$id+"/.priority"]=g+1,g++);this.ref.update(f)}else this.ref.setPriority((c+d)/2)}},posByKey:function(a){return e(this.list,a)},placeRecord:function(a,b){if(null===b)return 0;var c=this.posByKey(b);return-1===c?this.list.length:c+1},getRecord:function(a){var b=this.posByKey(a);return-1===b?null:this.list[b]},dispose:function(){var a=this.ref;this.subs.forEach(function(b){a.off(b[0],b[1])}),this.subs=[]},_serverAdd:function(a,b){this.snaps[a.key()]=a;var c=g(a.key(),a.val());this._moveTo(a.key(),c,b),this._handleEvent("child_added",a.key(),c)},_serverRemove:function(a){var b=this.posByKey(a.key());-1!==b&&(this.list.splice(b,1),this._handleEvent("child_removed",a.key(),this.list[b]))},_serverChange:function(a){this.snaps[a.key()]=a;var b=this.posByKey(a.key());-1!==b&&(this.list[b]=c(this.list[b],g(a.key(),a.val())),this._handleEvent("child_changed",a.key(),this.list[b]))},_serverMove:function(a,b){var c=a.key(),d=this.posByKey(c);if(-1!==d){var e=this.list[d];this.list.splice(d,1),this._moveTo(c,e,b),this._handleEvent("child_moved",a.key(),e)}},_moveTo:function(a,b,c){var d=this.placeRecord(a,c);this.list.splice(d,0,b)},_handleErrors:function(a,b){b&&(this._handleEvent("error",null,a),console.error(b))},_handleEvent:function(a,b,c){this.eventCallback&&this.eventCallback(a,b,c)},_wrapList:function(){this.list.$indexOf=this.posByKey.bind(this),this.list.$add=this.add.bind(this),this.list.$removeAt=this.removeAt.bind(this),this.list.$setAt=this.setAt.bind(this),this.list.$updateAt=this.updateAt.bind(this),this.list.$rawData=function(a){return f(this.getRecord(a))}.bind(this),this.list.$off=this.dispose.bind(this),this.list.$insert=this.insert.bind(this),this.list.$move=this.move.bind(this)},_initListeners:function(){this._monit("child_added",this._serverAdd),this._monit("child_removed",this._serverRemove),this._monit("child_changed",this._serverChange),this._monit("child_moved",this._serverMove)},_initPriorities:function(){var a=this;this.ref.once("value",function(b){var c=!0;if(b.forEach(function(a){null===a.getPriority()&&(c=!1)}),!c){var d={},e=0;b.forEach(function(a){d[a.key()+"/.priority"]=e++}),a.ref.update(d)}})},_monit:function(a,b){this.subs.push([a,this.ref.on(a,b.bind(this))])}}}("undefined"==typeof window?exports:window.Firebase);